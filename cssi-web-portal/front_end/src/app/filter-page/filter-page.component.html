<mat-sidenav-container class="sidenav-container">
  <mat-sidenav
    #drawer
    class="sidenav"
    fixedInViewport="false"
    [mode]="'over'"
    [opened]="false"
  >
    <mat-toolbar class="sidenav-toolbar"
      ><p class="sidenav-title">Menu</p></mat-toolbar
    >
    <mat-nav-list>
      <button class="absorb" mat-button></button>
      <!--That button is needed to fix Angular bug where 1st element will always be highlighted in sidenav if it is in over mode-->
      <a mat-list-item routerLink="/home">Home</a>
      <a mat-list-item routerLink="/organization/{{ orgId }}">Organization</a>
      <a mat-list-item routerLink="/application/{{ appId }}/{{ orgId }}"
        >Application</a
      >
      <a mat-list-item routerLink="/device/{{ orgId }}/{{ appId }}/{{ devName }}">
        Device</a>
      <a mat-list-item (click)="logout()"> Sign Out </a>
    </mat-nav-list>
  </mat-sidenav>
  <mat-sidenav-content>
    <mat-toolbar color="primary" class="toolbar">
      <button
        type="button"
        aria-label="Toggle sidenav"
        mat-icon-button
        (click)="drawer.toggle()"
      >
        <mat-icon aria-label="Side nav toggle icon">menu</mat-icon></button
      ><a routerLink="/home" class="color-white"><mat-icon class="home-icon" aria-label="Home icon">home</mat-icon><span class="home-text">Home</span></a><mat-icon aria-label="next arrow">navigate_next</mat-icon>
      <a routerLink="/organization/{{ orgId }}" class="color-white"
        >Organization</a
      ><mat-icon aria-label="next arrow">navigate_next</mat-icon>
      <a routerLink="/application/{{ appId }}/{{ orgId }}" class="color-white"
        >Application
      </a><mat-icon aria-label="next arrow">navigate_next</mat-icon>
      <a routerLink="/device/{{ orgId }}/{{ appId }}/{{ devName }}" class="color-white"
      >Device
    </a><mat-icon aria-label="next arrow">navigate_next</mat-icon>
    Filter Data
      <span class="push-button-right"></span
        ><button mat-raised-button color="warn" (click)="logout()">
          Sign Out <mat-icon class="leave-icon" aria-label="Sign Out icon">logout</mat-icon>
        </button></mat-toolbar
    >
    <button
    mat-raised-button
    color="accent"
    class="map-button"
    routerLink='/map/{{ orgId }}/{{appId}}/{{devName}}'
  >
    Check Map
  </button>
<body class="background">
  <!-- <mat-card class="filter"> -->
  <!-- <p class="header-text">Select Data</p> -->
  <!-- <mat-card class="filter"> -->
    <mat-accordion class="search-bar">
      <mat-expansion-panel
        class="search-expansion-box"
        (opened)="panelOpenState = true"
        (closed)="panelOpenState = false"
      >
        <!--This block indicates if the panel is open or not and adjusts the variable panelOpenState to the appropriate state-->
        <mat-expansion-panel-header>
          <mat-panel-title> Sort your data here! </mat-panel-title>
          <mat-panel-description>
            {{
              panelOpenState
                ? "Choose the parameters you'd like to view"
                : "Click me!"
            }}
          </mat-panel-description>
        </mat-expansion-panel-header>
        <!-- <img
          src="../../assets/placeholder_cat.jfif"
          alt="Grey cat sitting on couch"
        /> -->
        <form [formGroup]="filterForm" (ngSubmit)="onFormSubmit()">
          <!-- Data range of values -->
          <mat-card class="range-filter" formGroupName="range">
            <mat-card-content>
              <mat-card class="left-section-box">
                <section class="filter-select">
                  <mat-checkbox formControlName="payloadSelect"
                    >Apply to Payload Data</mat-checkbox
                  >
                </section>

                <section class="filter-select">
                  <mat-checkbox formControlName="metadataSelect"
                    >Apply to Metadata</mat-checkbox
                  >
                </section>
              </mat-card>
            </mat-card-content>

            <!-- data type vaule -->
              <mat-form-field>
                <mat-label>Column Name:</mat-label>
                <input matInput formControlName="dataType" />
                <mat-icon matSuffix>text_fields</mat-icon>
                <mat-hint>Enter Column Name: e.f. 'Temperature'</mat-hint>
              </mat-form-field>
            <!-- </mat-card> -->

          <!-- min vaule -->
            <mat-form-field>
              <mat-label>Minimum Value:</mat-label>
              <input matInput formControlName="min" />
              <mat-icon matSuffix>text_fields</mat-icon>
              <mat-hint>Enter Minimum Value</mat-hint>
            </mat-form-field>
          <!-- </mat-card> -->

          <!-- max vaule -->
            <mat-form-field>
              <mat-label>Maximum Value:</mat-label>
              <input matInput formControlName="max" />
              <mat-icon matSuffix>text_fields</mat-icon>
              <mat-hint>Enter Maximum Value</mat-hint>
            </mat-form-field>
          <!-- </mat-card> -->

          <!-- Device ID -->
            <mat-form-field>
              <mat-label>Device ID: ie '0025CA0A00015EEE'</mat-label>
              <input matInput formControlName="deviceId" />
              <mat-icon matSuffix>text_fields</mat-icon>
              <mat-hint>Enter Device ID</mat-hint>
            </mat-form-field>
          <!-- </mat-card> -->

          <!-- Date -->
            <mat-form-field>
              <mat-label>Date Information: ie 'Thu, 28 Dec 2023 05:21:39' </mat-label>
              <input matInput formControlName="dateInfo" />
              <mat-icon matSuffix>text_fields</mat-icon>
              <mat-hint>Enter Data Informatin</mat-hint>
            </mat-form-field>
          <!-- Num Entries -->
            <mat-form-field>
              <mat-label>Number Of Entries: e.g. 100' </mat-label>
              <input matInput formControlName="value" />
              <mat-icon matSuffix>text_fields</mat-icon>
              <mat-hint>Enter Number of Entries to View</mat-hint>
            </mat-form-field>
          </mat-card>

          <button type="submit" mat-raised-button color="primary">
            Submit
          </button>
        </form>
      </mat-expansion-panel>
    </mat-accordion>
  <!-- </mat-card> -->

  <!-- device payload data tables -->
  <mat-card class="filter">
    <!-- <mat-accordion class="search-bar">
      <mat-expansion-panel
        class="search-expansion-box"
        (opened)="panelOpenStatePayload = true"
        (closed)="panelOpenStatePayload = false" -->
      <!-- > -->
        <!--This block indicates if the panel is open or not and adjusts the variable panelOpenState to the appropriate state-->
        <!-- <mat-expansion-panel-header>
          <mat-panel-title> Payload Data </mat-panel-title>
          <mat-panel-description>
            {{
              panelOpenState
                ? "Choose the parameters you'd like to view"
                : "Click me!"
            }}
          </mat-panel-description>
        </mat-expansion-panel-header> -->
        <!-- <mat-card class="payload-table"> -->
          <!-- Filters need to be reintroduced into the tables when I can reliably display data -->
          <!-- Filters need to be refined further -->

          <!-- Filter for Payload -->
          <mat-form-field>
            <mat-label>Filter</mat-label>
            <input
              matInput
              (input)="applyPayloadFilter($event)"
              placeholder="Type to filter data, e.g., Dev_eui or Time"
              #input
            />
          </mat-form-field>

          <!--  Payload Table -->
          <p>Payload Table</p>
          <table
            mat-table
            [dataSource]="filteredPayloadDataSource"
            class="mat-elevation-z8"
          >
            <!-- Dev_eui Column -->
            <ng-container matColumnDef="Dev_eui" class="dev_eui">
              <th mat-header-cell *matHeaderCellDef>dev_eui</th>
              <td mat-cell *matCellDef="let element">{{ element.dev_eui }}</td>
            </ng-container>

            <!-- Dev_time Column -->
            <ng-container matColumnDef="Dev_time" class="dev_time">
              <th mat-header-cell *matHeaderCellDef>dev_time</th>
              <td mat-cell *matCellDef="let element">{{ element.dev_time }}</td>
            </ng-container>

            <!-- Payload Columns / Dynamic -->
            <ng-container
              *ngFor="let column of displayedPayloadColumns"
              [matColumnDef]="column"
              class="dynamic_column"> 

              <th mat-header-cell *matHeaderCellDef>{{ column }}</th>
              <td mat-cell *matCellDef="let element" [ngClass]="{'highlight': shouldHighlightPayload(element.payload_dict[column], displayedPayloadColumns.indexOf(column))}">
                {{ element.payload_dict[column] || 'N/A' }}
              </td>
              
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="['Dev_eui', 'Dev_time'].concat(displayedPayloadColumns)"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                columns: ['Dev_eui', 'Dev_time'].concat(displayedPayloadColumns)
              "
            ></tr>

            <!-- <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="4">No data matching the filter "{{input.value}}"</td>
            </tr> -->
          </table>

          <mat-paginator
            #filteredPayloadPaginator
            [pageSizeOptions]="[5, 10, 20]"
            showFirstLastButtons
            aria-label="Select page of Payload Data"
          ></mat-paginator>

        
        <!-- </mat-card> -->
          <mat-card-actions>
            <div class="button-container">
              <button
                mat-raised-button
                color="accent"
                (click)="loadSpinner(); exportPayloadData()"
              >
                Export Payload Data
              </button>
              <mat-spinner *ngIf="showSpinner"></mat-spinner>
            </div>
          </mat-card-actions>
      <!-- </mat-expansion-panel>
    </mat-accordion> -->
  </mat-card>

  <!-- payload graph -->
  <!-- <mat-card class="graph"> -->
    <mat-accordion class="search-bar">
      <mat-expansion-panel
        class="search-expansion-box"
        (opened)="panelOpenStatePayloadGraph = true"
        (closed)="panelOpenStatePayloadGraph = false"
      >
        <!--This block indicates if the panel is open or not and adjusts the variable panelOpenState to the appropriate state-->
        <mat-expansion-panel-header>
          <mat-panel-title> Payload Graph </mat-panel-title>
          <mat-panel-description>
            {{
              panelOpenState
                ? "Choose the parameters you'd like to view"
                : "Click me!"
            }}
          </mat-panel-description>
        </mat-expansion-panel-header>
        <!-- code here -->
        <mat-card class="chart">
          <canvas id="payloadChart" width="400" height="300"></canvas>
        </mat-card>
        <mat-card>
          <table
            mat-table
            [dataSource]="filteredPayloadStatSource"
            class="mat-elevation-z8"
          >
            <!-- devEUI Column -->
            <ng-container matColumnDef="devEUI" class="devEUI">
              <th mat-header-cell *matHeaderCellDef>Device Id</th>
              <td mat-cell *matCellDef="let element">{{ element.devEUI }}</td>
            </ng-container>
            <!-- Data Column -->
            <ng-container matColumnDef="column" class="column">
              <th mat-header-cell *matHeaderCellDef>Data</th>
              <td mat-cell *matCellDef="let element">{{ element.column }}</td>
            </ng-container>
            <!-- mean Column -->
            <ng-container matColumnDef="mean" class="mean">
              <th mat-header-cell *matHeaderCellDef>mean</th>
              <td mat-cell *matCellDef="let element">{{ element.mean }}</td>
            </ng-container>
            <!-- variance Column -->
            <ng-container matColumnDef="variance" class="variance">
              <th mat-header-cell *matHeaderCellDef>variance</th>
              <td mat-cell *matCellDef="let element">{{ element.variance }}</td>
            </ng-container>
            <!-- Standard Deviation Column -->
            <ng-container matColumnDef="standard_deviation" class="standard_deviation">
              <th mat-header-cell *matHeaderCellDef>Standard Deviation</th>
              <td mat-cell *matCellDef="let element"> {{ element.standard_deviation }} </td>
            </ng-container>
            <!-- median Column -->
            <ng-container matColumnDef="median" class="median">
              <th mat-header-cell *matHeaderCellDef>median</th>
              <td mat-cell *matCellDef="let element">{{ element.median }}</td>
            </ng-container>
            <!-- mode Column -->
            <ng-container matColumnDef="mode" class="mode">
              <th mat-header-cell *matHeaderCellDef>mode</th>
              <td mat-cell *matCellDef="let element">{{ element.mode }}</td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="[
                'devEUI',
                'column',
                'mean',
                'variance',
                'standard_deviation',
                'median',
                'mode'
              ]"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                columns: [
                  'devEUI',
                  'column',
                  'mean',
                  'variance',
                  'standard_deviation',
                  'median',
                  'mode'
                ]
              "
            ></tr>
          </table>
          <mat-paginator
            #payloadStatsPaginator
            [pageSizeOptions]="[5, 10, 20]"
            showFirstLastButtons
            aria-label="Select page of Payload Stats"
          ></mat-paginator>
        </mat-card>
        <mat-card-actions>
          <div class="button-container">
            <button
              mat-raised-button
              color="accent"
              (click)="loadSpinner()"
              (click)="getDownloadPayloadChart()"
            >
              Export Data
            </button>
          </div>
          <mat-spinner *ngIf="showSpinner"></mat-spinner>
        </mat-card-actions>
      </mat-expansion-panel>
    </mat-accordion>
  <!-- </mat-card> -->

  <!-- device metadata data tables -->
  <mat-card class="filter">
    <!-- <mat-accordion class="search-bar">
      <mat-expansion-panel
        class="search-expansion-box"
        (opened)="panelOpenStateMetadata = true"
        (closed)="panelOpenStateMetadata = false"
      > -->
        <!--This block indicates if the panel is open or not and adjusts the variable panelOpenState to the appropriate state-->
        <!-- <mat-expansion-panel-header>
          <mat-panel-title> Metadata </mat-panel-title>
          <mat-panel-description>
            {{
              panelOpenState
                ? "Choose the parameters you'd like to view"
                : "Click me!"
            }}
          </mat-panel-description>
        </mat-expansion-panel-header> -->
        <mat-card class="metadata-table">
          <!-- Filter for Metadata -->
          <mat-form-field>
            <mat-label>Filter</mat-label>
            <input
              matInput
              (keyup)="applyMetadataFilter($event)"
              placeholder="Dev_eui"
              #input
            />
          </mat-form-field>

          <!--  Metadata Table -->
          <p>Metadata Table</p>
          <table
            mat-table
            [dataSource]="filteredMetadataSource"
            class="mat-elevation-z8"
          >
            <!-- Dev_eui Column -->
            <ng-container matColumnDef="Dev_eui" class="dev_eui">
              <th mat-header-cell *matHeaderCellDef>dev_eui</th>
              <td mat-cell *matCellDef="let element">{{ element.dev_eui }}</td>
            </ng-container>

            <!-- Dev_time Column -->
            <ng-container matColumnDef="Dev_time" class="dev_time">
              <th mat-header-cell *matHeaderCellDef>dev_time</th>
              <td mat-cell *matCellDef="let element">{{ element.dev_time }}</td>
            </ng-container>

            <!-- SNR Column -->
            <ng-container matColumnDef="snr" class="snr">
              <th mat-header-cell *matHeaderCellDef>snr</th>
              <td mat-cell *matCellDef="let element">
                {{ element.metadata_dict.snr }}
              </td>
            </ng-container>

            <!-- RSSI Column -->
            <ng-container matColumnDef="rssi" class="rssi">
              <th mat-header-cell *matHeaderCellDef>rssi</th>
              <td mat-cell *matCellDef="let element">
                {{ element.metadata_dict.rssi  }}
              </td>
            </ng-container>

            <!-- Channel RSSI Column -->
            <ng-container matColumnDef="channel_rssi" class="channel_rssi">
              <th mat-header-cell *matHeaderCellDef>channel_rssi</th>
              <td mat-cell *matCellDef="let element">
                {{ element.metadata_dict.channel_rssi  }}
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="
                ['Dev_eui', 'Dev_time', 'snr','rssi','channel_rssi']
              "
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                columns:['Dev_eui', 'Dev_time', 'snr','rssi','channel_rssi']
              "
            ></tr>

          </table>

          <mat-paginator
            #filteredMetadataPaginator
            [pageSizeOptions]="[5, 10, 20]"
            showFirstLastButtons
            aria-label="Select page of Metadata Data"
          ></mat-paginator>

          
        </mat-card>
          <mat-card-actions>
            <div class="button-container">
              <button
                mat-raised-button
                color="accent"
                (click)="loadSpinner(); exportMetadata()"
              >
                Export Metadata Data
              </button>
              <mat-spinner *ngIf="showSpinner"></mat-spinner>
            </div>
          </mat-card-actions>
      <!-- </mat-expansion-panel>
    </mat-accordion> -->
  </mat-card>

  <!-- metadata graph -->
  <!-- <mat-card class="graph"> -->
    <mat-accordion class="search-bar">
      <mat-expansion-panel
        class="search-expansion-box"
        (opened)="panelOpenStateMetadataGraph = true"
        (closed)="panelOpenStateMetadataGraph = false"
      >
        <!--This block indicates if the panel is open or not and adjusts the variable panelOpenState to the appropriate state-->
        <mat-expansion-panel-header>
          <mat-panel-title> Metadata Statistics </mat-panel-title>
          <mat-panel-description>
            {{
              panelOpenState
                ? "Choose the parameters you'd like to view"
                : "Click me!"
            }}
          </mat-panel-description>
        </mat-expansion-panel-header>
        <!-- code here -->
        <!-- <mat-card class="chart">
          <canvas id="metadataChart"  width="400" height="200"></canvas>
        </mat-card> -->
        <mat-card>
          <table
            mat-table
            [dataSource]="filteredMetadataStatSource"
            class="mat-elevation-z8"
          >
          <!-- devEUI Column -->
          <ng-container matColumnDef="devEUI" class="devEUI">
            <th mat-header-cell *matHeaderCellDef>Device Id</th>
            <td mat-cell *matCellDef="let element">{{ element.devEUI }}</td>
          </ng-container>
          <!-- Data Column -->
          <ng-container matColumnDef="column" class="column">
            <th mat-header-cell *matHeaderCellDef>Data</th>
            <td mat-cell *matCellDef="let element">{{ element.column }}</td>
          </ng-container>
          <!-- mean Column -->
          <ng-container matColumnDef="mean" class="mean">
            <th mat-header-cell *matHeaderCellDef>mean</th>
            <td mat-cell *matCellDef="let element">{{ element.mean }}</td>
          </ng-container>
          <!-- variance Column -->
          <ng-container matColumnDef="variance" class="variance">
            <th mat-header-cell *matHeaderCellDef>variance</th>
            <td mat-cell *matCellDef="let element">{{ element.variance }}</td>
          </ng-container>
          <!-- Standard Deviation Column -->
          <ng-container matColumnDef="standard_deviation" class="standard_deviation">
            <th mat-header-cell *matHeaderCellDef>Standard Deviation</th>
            <td mat-cell *matCellDef="let element"> {{ element.standard_deviation }} </td>
          </ng-container>
          <!-- median Column -->
          <ng-container matColumnDef="median" class="median">
            <th mat-header-cell *matHeaderCellDef>median</th>
            <td mat-cell *matCellDef="let element">{{ element.median }}</td>
          </ng-container>
          <!-- mode Column -->
          <ng-container matColumnDef="mode" class="mode">
            <th mat-header-cell *matHeaderCellDef>mode</th>
            <td mat-cell *matCellDef="let element">{{ element.mode }}</td>
          </ng-container>

          <tr
            mat-header-row
            *matHeaderRowDef="[
              'devEUI',
              'column',
              'mean',
              'variance',
              'standard_deviation',
              'median',
              'mode'
            ]"
          ></tr>
          <tr
            mat-row
            *matRowDef="
              let row;
              columns: [
                'devEUI',
                'column',
                'mean',
                'variance',
                'standard_deviation',
                'median',
                'mode'
              ]
            "
          ></tr>
        </table>
        <mat-paginator
          #metadataStatsPaginator
          [pageSizeOptions]="[5, 10, 20]"
          showFirstLastButtons
          aria-label="Select page of Metadata Stats"
        ></mat-paginator>
        </mat-card>
        <!-- The mat card will also have buttons present to retrieve user input and specific what infromation the user would like to view with respect tot he device health. -->
        <!-- using event based binding which will use the correpsonding method and allow the user to view the selected information visuallized with the chart, here the chart is specified-->
        <!-- through canvas element "payloadChart" -->
        <mat-card-actions>
          <div class="button-container">
            <button
              mat-raised-button
              color="accent"
              (click)="loadSpinner()"
              (click)="getDownloadMetadataChart()"
            >
              Export Data
            </button>
          </div>
          <mat-spinner *ngIf="showSpinner"></mat-spinner>
        </mat-card-actions>
      </mat-expansion-panel>
    </mat-accordion>
  <!-- </mat-card> -->
</body>
</mat-sidenav-content>
</mat-sidenav-container>
